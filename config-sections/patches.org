#+TITLE: Patches
#+DESCRIPTION: File meant to be for patches/hacks while waiting for the official repo authors to push their fixes

* =shell=
Fix the fact that closing the window also kills the buffer. We don't want this
#+begin_src elisp :results none
(use-package! shell
  :config
  (defun +shell/toggle (&optional command)
    "Toggle a persistent terminal popup window.

If popup is visible but unselected, selected it.
If popup is focused, kill it."
    (interactive)
    (let ((buffer
           (get-buffer-create
            (format "*doom:shell-popup:%s*"
                    (if (bound-and-true-p persp-mode)
                        (safe-persp-name (get-current-persp))
                      "main"))))
          (dir default-directory))
      (if-let (win (get-buffer-window buffer))
          (let (confirm-kill-processes)
            (set-process-query-on-exit-flag (get-buffer-process buffer) nil)
            (delete-window win))
        (with-current-buffer buffer
          (if (not (eq major-mode 'shell-mode))
              (shell buffer)
            (cd dir)
            (run-mode-hooks 'shell-mode-hook)))
        (pop-to-buffer buffer))
      (+shell--send-input buffer command))))

(defun +shell--send-input (buffer input &optional no-newline)
  (when input
    (with-current-buffer buffer
      (unless (number-or-marker-p (cdr comint-last-prompt))
        (message "Waiting for shell to start up...")
        (while (not (number-or-marker-p (cdr comint-last-prompt)))
          (sleep-for 0.1)))
      (goto-char (cdr comint-last-prompt))
      (delete-region (cdr comint-last-prompt) (point-max))
      (insert input)
      (comint-send-input no-newline))))
#+end_src
